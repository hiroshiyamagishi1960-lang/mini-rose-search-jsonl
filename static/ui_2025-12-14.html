<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ミニバラ盆栽愛好会 デジタル資料館</title>
  <style>
    :root{--bd:#e5e7eb;--muted:#6b7280;--pill:#fff4cc;--pillbd:#ffe08a;--card:#ffffff;--bg:#fafafa}
    html,body{background:#fff;margin:0;padding:0}
    html{font-size:18px}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";line-height:1.8;padding:28px}
    h1{font-size:28px;margin:0 0 22px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:18px;margin:18px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"]{flex:1 1 520px;padding:12px 14px;border:1px solid var(--bd);border-radius:12px;font-size:18px}
    button{padding:10px 16px;border:1px solid var(--bd);border-radius:12px;background:#f7f7f7;cursor:pointer;font-size:16px}
    button.primary{background:#e7f0ff;border-color:#9bbcff}
    .hint{display:inline-block;background:var(--pill);border:1px solid var(--pillbd);border-radius:999px;padding:6px 12px;font-size:14px}
    .label{font-weight:700;margin:12px 0 8px}
    pre{white-space:pre-wrap;word-break:break-word;background:var(--bg);border:1px solid var(--bd);border-radius:12px;padding:14px;margin:8px 0;font-size:16px}
    details summary{cursor:pointer;color:#1f2937}
    small{color:var(--muted)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <h1>ミニバラ盆栽愛好会 デジタル資料館</h1>

  <!-- チャットは一時停止のお知らせ -->
  <div class="card">
    <div class="hint">お知らせ</div>
    <div style="margin-top:8px">チャット機能は現在メンテナンスのため一時停止中です。検索をご利用ください。</div>
  </div>

  <!-- 検索：/api/search -->
  <div class="card" id="search-card">
    <div class="row" style="justify-content:space-between">
      <div><b style="font-size:20px">検索システム</b>　<small>API: /api/search</small></div>
      <div class="hint">1位＝本文＋主要項目／2位以下＝見出し＋出典リンク（最大5件）</div>
    </div>
    <div class="row" style="margin-top:10px">
      <input id="search-q" type="text" placeholder="例）苔　例）剪定　例）施肥　例）接ぎ木　例）盆景と盆栽の違い" />
      <button class="primary" id="btn-search">検索</button>
      <button id="btn-search-clear">クリア</button>
    </div>
    <div class="label">検索結果（整形表示）</div>
    <pre id="search-text">（未取得）</pre>
    <details>
      <summary>開発者向け：レスポンス（生のJSON）</summary>
      <pre id="search-json">（未取得）</pre>
    </details>
    <div class="muted" style="margin-top:8px">※ ハイライト（黄色）はサーバ側の <code>&lt;mark&gt;</code> をそのまま表示しています。</div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const sanitize = (s) => (typeof s === "string") ? s : "";
    const asArray = (x) => Array.isArray(x) ? x : [];

    // ===== /api/search =====
    function pick(...cands){ for (const k of cands){ if (k && typeof k==="string") return k; } return ""; }
    function normalizeSearchResponse(data){
      if (!data) return {items:[]};
      let items = [];
      if (Array.isArray(data.items)) items = data.items;
      else if (Array.isArray(data.results)) items = data.results;
      const mapped = items.map(r => {
        const title   = pick(r.title, r.tTitle, r.head, r.heading);
        const content = pick(r.content, r.text, r.body, r.tContent);
        const url     = pick(r.url, r.link);
        const source  = pick(r.source, url);
        return { title, content, url, source, rank: r.rank ?? null };
      });
      return { items: mapped };
    }
    async function callSearch(q) {
      const url = `/api/search?q=${encodeURIComponent(q)}&top_k=5`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (res.status === 404) return { __not_impl: true, detail: "Not Found" };
      if (!res.ok) { throw new Error(`HTTP ${res.status}: ${await res.text()}`); }
      return await res.json();
    }
    function linkOrText(url){
      const u = sanitize(url);
      return u ? `<a href="${u}" target="_blank" rel="noopener">${u}</a>` : "（不明）";
    }
    async function onSearch() {
      const q = $("search-q")?.value?.trim() || "";
      if (!q) { $("search-text").textContent="（キーワードが空です）"; $("search-json").textContent="{}"; return; }
      $("search-text").textContent = "検索中…"; $("search-json").textContent = "…";
      try {
        const raw = await callSearch(q);
        if (raw.__not_impl) {
          $("search-text").textContent = "（この環境では /api/search は未対応です）";
          $("search-json").textContent = JSON.stringify({detail:"Not Found"}, null, 2);
          return;
        }
        const data = normalizeSearchResponse(raw);
        const items = asArray(data.items);
        let html = "（該当なし）";
        if (items.length) {
          const lines = [];
          items.forEach((it, i) => {
            const title = sanitize(it.title || "(無題)");
            const content = sanitize(it.content || "");
            const src = linkOrText(it.source || it.url || "");
            if (i === 0) {
              const short = content.length > 900 ? `${content.slice(0,900)} …` : content;
              lines.push(`【1位】 ${title}`);
              lines.push(short ? `本文抜粋：<br>${short}` : "本文抜粋：（なし）");
              lines.push(`出典：${src}`); lines.push("");
            } else {
              lines.push(`・${title} —— ${src}`);
            }
          });
          html = lines.join("\n");
        }
        $("search-text").innerHTML = html;
        $("search-json").textContent = JSON.stringify(raw, null, 2);
      } catch(e) {
        $("search-text").textContent = `エラー：${e.message}`; $("search-json").textContent = "{}";
      }
    }
    function onSearchClear(){ $("search-q").value=""; $("search-text").textContent="（未取得）"; $("search-json").textContent="（未取得）"; }
    $("btn-search").addEventListener("click", onSearch);
    $("btn-search-clear").addEventListener("click", onSearchClear);
    $("search-q").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); onSearch(); } });
  </script>
</body>
</html>
