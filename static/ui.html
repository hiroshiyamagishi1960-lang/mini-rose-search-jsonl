<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ミニバラ盆栽愛好会 デジタル資料館｜検索（JSONL版）</title>

<!-- ▼ 版識別子（この1行の日付だけ変えればOK） -->
<script>window.VER = "2025-11-01";</script>

<!-- ▼ PWA: 版付きで強制更新（manifest / icons / sw すべて同じ VER を付与） -->
<link rel="manifest" href="/static/manifest.json?v=<script>document.write(window.VER)</script>">
<link rel="apple-touch-icon" href="/static/icons/icon-180.png?v=<script>document.write(window.VER)</script>" sizes="180x180">
<link rel="icon" href="/static/icons/icon-192.png?v=<script>document.write(window.VER)</script>" sizes="192x192" type="image/png">
<meta name="theme-color" content="#AEE6B8">

<meta name="robots" content="noindex" />
<style>
  :root{
    --bg:#fafafa; --card:#fff; --b:#e5e7eb; --muted:#64748b; --txt:#0f172a;
    --link:#2563eb; --hl:#e6f3ff; --ink:#1e3a8a; --inbg:#eaf2ff;
    --warn:#fff7cc; --warn-b:#fde68a; --how:#ffeff0; --how-b:#fecdd3;
  }
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.7}
  html{font-size:20px}
  @media (max-width:480px){ html{font-size:21px} }

  .container{max-width:1000px;margin:18px auto;padding:0 16px}
  h1{margin:0 0 12px;font-size:28px}

  .toolbar{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .api{font-size:12px;color:var(--muted)}

  input[type="text"]{
    flex:1 1 520px;min-width:260px;
    padding:16px 18px;border-radius:12px;background:var(--inbg);
    border:3px solid var(--ink); outline:none; font-size:20px;
  }
  select,button{border:1px solid var(--b);border-radius:10px;background:#fff;font-size:16px;line-height:1.2}
  select{padding:10px 12px}
  button{padding:12px 16px;cursor:pointer;min-height:44px;background:#f8fafc}
  button.primary{background:#e7f0ff;border-color:#bfdbfe}
  button[disabled]{opacity:.5;cursor:not-allowed}

  .section{background:var(--card);border:1px solid var(--b);border-radius:16px;margin-top:16px}
  .section h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--b);font-size:16px}
  .section .body{padding:12px 16px}

  .meta{font-size:14px;margin-bottom:8px;color:var(--muted)}
  .result{border:1px solid var(--b);border-radius:14px;padding:12px;background:#fff;margin-bottom:12px}
  .title{font-weight:700;font-size:22px;margin-bottom:6px}
  .snippet{white-space:pre-wrap;word-break:break-word}
  .hit{display:inline-block;font-size:12px;color:#1d4ed8;background:#e0ecff;border:1px solid #bfdbfe;border-radius:999px;padding:2px 8px;margin-left:6px}
  .src{font-size:15px;margin-top:10px}
  .src a{
    display:inline-block;padding:10px 12px;border:1px solid var(--b);border-radius:10px;
    color:var(--link);text-decoration:none;-webkit-tap-highlight-color:transparent;
  }
  .src .rawurl{display:block;margin-top:6px;word-break:break-all}
  mark{background:var(--hl);padding:0 .15em;border-radius:3px}

  .badge{display:inline-block;background:#fff7ed;border:1px solid #fed7aa;border-radius:999px;padding:4px 10px;font-size:12px;color:#92400e}
  .notice{margin-top:16px;background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:10px}
  .howto{margin-top:16px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:10px}
  .date{font-size:14px;color:#374151;margin-top:2px}
</style>
</head>
<body>
  <div class="container">
    <h1>ミニバラ盆栽愛好会 デジタル資料館</h1>

    <div class="toolbar">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700;color:#ef4444">検索システム</div>
        <span class="badge">年でしぼる＋ページ送り</span>
      </div>

      <div class="row" style="margin-top:8px">
        <input id="q" type="text" placeholder="例） コンテスト結果　／　例） コンテスト 2023　／　例） 姫乙女 受賞" />
        <select id="order" title="並び順" disabled>
          <option value="relevance">関連順</option>
          <option value="latest" selected>最新順</option>
        </select>
        <button class="primary" id="btnSearch">検索</button>
        <button id="btnClear">クリア</button>
      </div>

      <div class="api" style="margin-top:6px">
        API: <code>/api/search</code> ｜ 版: <span id="ver">…</span> ｜
        <!-- ▼ PWA時は外部ブラウザで開く（戻れない問題の解消） -->
        <a id="lnkHealth" href="/health">/health</a> ・
        <a id="lnkVersion" href="/version">/version</a><br/>
        ※ この画面の検索は <strong>常に「最新順（order=latest）」で表示</strong> します。
      </div>
    </div>

    <div class="section">
      <h2>検索結果（整形表示）</h2>
      <div class="body">
        <div id="meta" class="meta">（未取得）</div>
        <div id="results"></div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="prev" disabled>前へ</button>
          <button id="next" disabled>次へ</button>
        </div>
      </div>
    </div>

    <div class="notice">
      <strong>お知らせ</strong><br/>
      チャット機能はメンテナンスのため一時停止中です。検索をご利用ください。
    </div>

    <div class="howto">
      <h3>使いかた</h3>
      <ol style="margin:6px 0 0;padding-left:1.2em">
        <li>ことばを入れて「検索」を押す。</li>
        <li>1ページは<strong>常に5件</strong>。先頭だけ<strong>本文を約300字</strong>表示、2〜5件は<strong>ハイライト周辺</strong>のみ。</li>
        <li>続きは次へ、戻るときは前へ（ページ送り）。</li>
        <li>年でしぼるときは語尾に西暦4桁。<span style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px">例：コンテスト 2023</span></li>
        <li>年の範囲はハイフン。<span style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px">例：剪定 1999-2001</span></li>
      </ol>
    </div>
  </div>

<script>
  const PAGE_SIZE = 5;
  const $ = (id) => document.getElementById(id);
  const asArray = (x) => Array.isArray(x) ? x : [];

  async function jget(url){
    const r = await fetch(url, {cache:"no-store", headers:{Accept:"application/json"}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }

  function hasMark(html){ return /<mark>/.test(html||""); }

  function setPagerDisabled(disabled){
    $("prev").disabled = disabled;
    $("next").disabled = disabled;
  }

  function whereHit(matches){
    if(!matches) return "";
    const labels = [];
    if(matches.title && matches.title.length) labels.push("タイトルにヒット");
    if(matches.tags  && matches.tags.length)  labels.push("タグにヒット");
    if(matches.body  && matches.body.length)  labels.push("本文にヒット");
    return labels.length ? `（${labels.join("・")}）` : "";
  }

  async function doSearch(page){
    const q=$("q").value.trim(); if(!q){
      $("results").innerHTML=""; $("meta").textContent="（未取得）";
      setPagerDisabled(true);
      return;
    }
    $("btnSearch").disabled=true; $("meta").textContent="検索中…"; $("results").innerHTML="";
    try{
      const ord="latest"; // UI側は常に最新順
      const url=`/api/search?q=${encodeURIComponent(q)}&page=${page}&page_size=${PAGE_SIZE}&order=${encodeURIComponent(ord)}&debug=1`;
      const raw=await jget(url);
      const items=asArray(raw?.items)||[];
      if(!items.length){
        $("meta").textContent="該当なし";
        $("results").innerHTML="";
        setPagerDisabled(true);
        return;
      }

      $("results").innerHTML=items.map((it,i)=>{
        const title = it.title || "(無題)";
        const content = it.content || "";
        const url = it.url || "";
        const hitLabel = whereHit(it.matches) || (hasMark(content) ? "（本文にヒット）" : "");
        const link = url ? `<div class="src"><a href="${url}" target="_blank" rel="noopener noreferrer">本文表示（クリックして下さい。）</a></div>` : "";
        const date = it.date ? `<div class="date">発行日：${it.date}</div>` : "";
        return `<div class="result"><div class="title">${title}<span class="hit">${hitLabel || "\u00A0"}</span></div><div class="snippet">${content}</div>${date}${link}</div>`;
      }).join("");

      const total = raw.total_hits ?? items.length;
      const from = (page-1)*PAGE_SIZE + 1;
      const to   = Math.min(page*PAGE_SIZE, total);
      $("meta").textContent=`${total} 件中 ${from}–${to} 件を表示（${raw.order_used||ord}）`;
      $("prev").disabled = page<=1;
      $("next").disabled = !raw.has_more;
      window.__page=page;
    }catch(e){
      $("meta").textContent=`エラー：${String(e.message||e)}`;
      setPagerDisabled(true);
    }finally{ $("btnSearch").disabled=false; }
  }

  // --- イベント
  $("btnSearch").addEventListener("click", ()=>doSearch(1));
  $("btnClear").addEventListener("click", ()=>{ $("q").value=""; $("results").innerHTML=""; $("meta").textContent="（未取得）"; setPagerDisabled(true); });
  $("prev").addEventListener("click", ()=>{ const p=Math.max(1,(window.__page||1)-1); doSearch(p); });
  $("next").addEventListener("click", ()=>{ const p=(window.__page||1)+1; doSearch(p); });
  $("q").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ doSearch(1); } });

  (async ()=>{ try{ const r=await jget("/version"); $("ver").textContent=r.version||"—"; }catch{} })();

  // --- PWA: Service Worker 登録（方式B：登録URLは /static/... のまま）
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      const sw = `/static/service-worker.js?v=${encodeURIComponent(window.VER)}`;
      navigator.serviceWorker.register(sw).catch(()=>{});
    });
  }

  // --- /health /version リンク：アプリ内で開く（SWのラッパーを効かせる）
  const lH = $("lnkHealth"), lV = $("lnkVersion");
  if (lH && lV) {
    const verQ = (u)=> `${u}${u.includes("?")?"&":"?"}v=${encodeURIComponent(window.VER)}`;
    lH.href = verQ("/health");
    lV.href = verQ("/version");
    // ※ ここでは何もしません（外部ブラウザへ飛ばさない）
    // そのまま通常のリンク遷移にすることで、SWが /health /version をラップし、
    // 「← 検索画面に戻る」付きHTMLを返します。
  }
</script>
