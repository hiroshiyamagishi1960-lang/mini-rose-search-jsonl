<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ミニバラ盆栽愛好会 | 検索（JSONL版）</title>
  <style>
    :root{--c1:#0f172a;--c2:#475569;--c3:#94a3b8;--a:#2563eb;--bg:#f8fafc}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--c1);margin:0}
    header{padding:16px 20px;background:white;border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:2}
    h1{margin:0;font-size:18px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    input[type="text"]{flex:1;min-width:220px;padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px}
    select,button{padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;background:white}
    button.primary{background:var(--a);color:#fff;border-color:var(--a)}
    main{max-width:980px;margin:20px auto;padding:0 16px}
    .meta{font-size:12px;color:var(--c2);margin:8px 0 12px}
    .card{background:white;border:1px solid #e2e8f0;border-radius:12px;padding:14px 14px 10px;margin-bottom:12px}
    .title{font-weight:700;font-size:16px;line-height:1.4;margin-bottom:6px}
    .info{font-size:12px;color:var(--c2);display:flex;gap:10px;flex-wrap:wrap}
    .snippet{margin-top:8px;color:#111827;font-size:14px;line-height:1.7}
    .snippet, .title{word-break:break-word}
    .foot{margin:24px 0 40px;color:var(--c3);font-size:12px}
    .links a{color:var(--a);text-decoration:none}
    mark{background:#cdeafe;padding:0 2px;border-radius:2px}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;font-size:11px}
  </style>
</head>
<body>
<header>
  <h1>ミニバラ盆栽愛好会 | 検索（JSONL版）</h1>
  <div class="bar">
    <input id="q" type="text" placeholder="例：コンテスト結果 / 黒星病 2024 / 盆景 1999-2001" />
    <select id="pageSize">
      <option value="5">5件</option>
      <option value="10">10件</option>
      <option value="20">20件</option>
    </select>
    <select id="order">
      <option value="relevance">関連順</option>
      <option value="latest">最新順</option>
    </select>
    <button class="primary" id="doSearch">検索</button>
    <button id="clear">クリア</button>
  </div>
  <div class="meta">
    API: <code>/api/search</code> |
    版: <span id="ver">…</span> |
    <span class="links">
      <a href="/health" target="_blank">/health</a> ・
      <a href="/version" target="_blank">/version</a>
    </span>
  </div>
</header>

<main>
  <div id="resultMeta" class="meta"></div>
  <div id="list"></div>
  <div class="foot" id="footNote">
    ※ タイトルと本文の<strong>ハイライト（薄い青）</strong>はサーバからの
    <code>&lt;mark&gt;</code> をそのまま表示しています（UIは <code>innerHTML</code> で描画）。
  </div>
</main>

<script>
(async function bootstrap(){
  // 版表示
  try{
    const v = await fetch('/version').then(r=>r.json());
    document.getElementById('ver').textContent = v.version || 'unknown';
  }catch(_){}

  const elQ = document.getElementById('q');
  const elPS= document.getElementById('pageSize');
  const elOrd=document.getElementById('order');
  const elBtn=document.getElementById('doSearch');
  const elClr=document.getElementById('clear');
  const elList=document.getElementById('list');
  const elMeta=document.getElementById('resultMeta');

  // 既定：関連順（サーバも既定relevance）。UIから latest を強制しません。
  elOrd.value = 'relevance';

  function rowHTML(item){
    const titleHTML = item.title || '(無題)';
    const url = item.url || '#';
    const date = item.date || '';
    const snippetHTML = item.content || '';

    return `
      <div class="card">
        <div class="title"><a href="${url}" target="_blank" rel="noopener noreferrer">
          ${titleHTML}
        </a></div>
        <div class="info">
          ${date ? `<span class="pill">日付: ${date}</span>` : ``}
          <span class="pill">順位: ${item.rank ?? ''}</span>
          ${item.url ? `<span class="pill">外部リンク</span>`:``}
        </div>
        <div class="snippet">${snippetHTML}</div>
      </div>
    `;
  }

  async function search(page=1){
    const q = elQ.value.trim();
    if(!q){ elList.innerHTML=''; elMeta.textContent=''; return; }

    const pageSize = Number(elPS.value) || 5;
    const order = elOrd.value; // relevance / latest
    const url = `/api/search?q=${encodeURIComponent(q)}&page=${page}&page_size=${pageSize}&order=${encodeURIComponent(order)}`;

    const res = await fetch(url);
    const js = await res.json();

    elMeta.textContent = `${js.total_hits} 件中 ${js.items.length ? js.items[0].rank : 0}–${js.items.length ? js.items[js.items.length-1].rank : 0} 件を表示 / order_used: ${js.order_used}`;
    elList.innerHTML = js.items.map(rowHTML).join('');
  }

  elBtn.addEventListener('click', ()=>search(1));
  elClr.addEventListener('click', ()=>{
    elQ.value=''; elList.innerHTML=''; elMeta.textContent='';
  });

  // Enter で検索
  elQ.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ search(1); } });

  // URLに ?q= があればそれで検索
  const usp = new URLSearchParams(location.search);
  if(usp.get('q')){ elQ.value = usp.get('q'); search(1); }
})();
</script>
</body>
</html>
