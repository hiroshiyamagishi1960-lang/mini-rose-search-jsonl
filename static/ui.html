<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒŸãƒ‹ãƒãƒ©ç›†æ ½æ„›å¥½ä¼š ãƒ‡ã‚¸ã‚¿ãƒ«è³‡æ–™é¤¨</title>

  <!-- PWA: manifest / theme-color / iOSç”¨ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚¢ã‚¤ã‚³ãƒ³ -->
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ãƒŸãƒ‹ãƒãƒ©ç›†æ ½è³‡æ–™é¤¨" />

  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", "Segoe UI", system-ui, sans-serif;
      background: #f9fafb;
      color: #111;
      margin: 0;
      padding: 1.5rem;
    }
    h1 { font-size: 1.6rem; margin-bottom: .5rem; }
    #q {
      width: 100%;
      padding: .6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
      margin-bottom: 1rem;
    }
    button {
      padding: .5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: .5rem;
      background: #4b5563;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #374151; }
    .result {
      background: white;
      border-radius: .5rem;
      padding: 1rem;
      margin-top: .8rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    mark {
      background: #fff59d;
      padding: 0 2px;
      border-radius: 2px;
    }
    .api {
      font-size: 0.9rem;
      color: #475569;
    }
    .footer {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 2rem;
      text-align: right;
    }
  </style>
</head>

<body>
  <h1>ãƒŸãƒ‹ãƒãƒ©ç›†æ ½æ„›å¥½ä¼š ãƒ‡ã‚¸ã‚¿ãƒ«è³‡æ–™é¤¨</h1>

  <input id="q" type="text" placeholder="æ¤œç´¢èªã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå‰ªå®š è‹” å±•ç¤ºä¼š...ï¼‰" />
  <div>
    <button onclick="doSearch(1)">æ¤œç´¢</button>
  </div>

  <div id="out"></div>

  <div class="api" style="margin-top:6px">
    API: <code>/api/search</code> ï½œ ç‰ˆ: <span id="ver">â€¦</span> ï½œ
    <a href="/health" target="_blank" rel="noopener">/health</a> ãƒ»
    <a href="/version" target="_blank" rel="noopener">/version</a>
    ãƒ» <span id="readyState" style="color:#64748b">æº–å‚™çŠ¶æ…‹: å–å¾—ä¸­â€¦</span>
  </div>

  <div class="footer">
    &copy; ãƒŸãƒ‹ãƒãƒ©ç›†æ ½æ„›å¥½ä¼š / Hiroshi Yamagishi
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const api = "/api/search";

    async function jget(url){
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error(r.status);
      return await r.json();
    }

    async function doSearch(page){
      const q = $("q").value.trim();
      if(!q){ $("out").innerHTML="<p>æ¤œç´¢èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>"; return; }
      $("out").innerHTML="<p>æ¤œç´¢ä¸­...</p>";
      try{
        const url = `${api}?q=${encodeURIComponent(q)}&page=${page}&page_size=5&order=latest`;
        const j = await jget(url);
        render(j);
      }catch(e){
        $("out").innerHTML="<p>ã‚¨ãƒ©ãƒ¼: "+e+"</p>";
      }
    }

    function render(j){
      if(!j || !j.items){ $("out").innerHTML="<p>è©²å½“ãªã—ã€‚</p>"; return; }
      const out=[];
      out.push(`<p>ãƒ’ãƒƒãƒˆä»¶æ•°: ${j.total_hits} ä»¶ã€€ï¼ˆãƒšãƒ¼ã‚¸ ${j.page}ï¼‰</p>`);
      for(const it of j.items){
        out.push(`<div class="result">
          <div><strong>${it.title}</strong></div>
          <div>${it.content||""}</div>
          <div style="margin-top:4px;font-size:0.9rem;">
            <a href="${it.url||'#'}" target="_blank" rel="noopener">æœ¬æ–‡è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼‰</a>
            ${it.date_primary ? "ã€€ğŸ“… "+it.date_primary : "" }
          </div>
        </div>`);
      }
      $("out").innerHTML = out.join("");
    }

    async function showReady(){
      try{
        const r = await fetch("/ready", {cache:"no-store"});
        if(!r.ok) throw new Error("ready ng");
        const j = await r.json();
        const s = j?.ok ? "OK" : (j?.detail || "æº–å‚™ä¸­");
        const el = $("readyState");
        if(el){ el.textContent = `æº–å‚™çŠ¶æ…‹: ${s}`; }
      }catch{
        const el = $("readyState");
        if(el){ el.textContent = "æº–å‚™çŠ¶æ…‹: ä¸æ˜"; }
      }
    }

    (async ()=>{
      try{
        const v = await jget("/version");
        $("ver").textContent = v.version || "â€”";
      }catch{}
      await showReady();
      const usp=new URLSearchParams(location.search);
      if(usp.get("q")){ $("q").value=usp.get("q"); doSearch(1); }
    })();
  </script>
</body>
</html>
