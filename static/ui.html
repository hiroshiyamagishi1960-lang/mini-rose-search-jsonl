<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒŸãƒ‹ãƒãƒ©ç›†æ ½æ„›å¥½ä¼š ãƒ‡ã‚¸ã‚¿ãƒ«è³‡æ–™é¤¨ï½œæ¤œç´¢ï¼ˆJSONLç‰ˆï¼‰</title>

<!-- â–¼ UIç‰ˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥è­˜åˆ¥ï¼‰â€»å¿…è¦ãªã‚‰æ—¥ä»˜ã ã‘å¤‰æ›´å¯ -->
<script>window.VER = "2025-11-02";</script>

<!-- â–¼ PWAï¼ˆå¿…è¦ãªã‚‰ manifest / icons ã‚’é‹ç”¨ã«åˆã‚ã›ã¦ï¼‰ -->
<link rel="manifest" href="/static/manifest.json">
<link rel="apple-touch-icon" href="/static/icons/icon-180.png" sizes="180x180">
<link rel="icon" href="/static/icons/icon-192.png" sizes="192x192" type="image/png">
<meta name="theme-color" content="#AEE6B8">
<meta name="robots" content="noindex" />

<style>
  :root{
    --bg:#fafafa; --card:#fff; --b:#e5e7eb; --muted:#64748b; --txt:#0f172a;
    --link:#2563eb; --hl:#e6f3ff; --ink:#1e3a8a; --inbg:#eaf2ff;
    --warn:#fff7cc; --warn-b:#fde68a; --how:#ffeff0; --how-b:#fecdd3;
  }
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.7}
  html{font-size:20px}
  @media (max-width:480px){ html{font-size:21px} }

  .container{max-width:1000px;margin:18px auto;padding:0 16px}
  h1{margin:0 0 12px;font-size:28px}

  .toolbar{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .api{font-size:12px;color:var(--muted)}

  input[type="text"]{
    flex:1 1 520px;min-width:260px;
    padding:16px 18px;border-radius:12px;background:var(--inbg);
    border:3px solid var(--ink); outline:none; font-size:20px;
  }
  select,button{border:1px solid var(--b);border-radius:10px;background:#fff;font-size:16px;line-height:1.2}
  select{padding:10px 12px}
  button{padding:12px 16px;cursor:pointer;min-height:44px;background:#f8fafc}
  button.primary{background:#e7f0ff;border-color:#bfdbfe}
  button[disabled]{opacity:.5;cursor:not-allowed}

  .section{background:var(--card);border:1px solid var(--b);border-radius:16px;margin-top:16px}
  .section h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--b);font-size:16px}
  .section .body{padding:12px 16px}

  .meta{font-size:14px;margin-bottom:8px;color:var(--muted)}
  .result{border:1px solid var(--b);border-radius:14px;padding:12px;background:#fff;margin-bottom:12px}
  .title{font-weight:700;font-size:22px;margin-bottom:6px}
  .snippet{white-space:pre-wrap;word-break:break-word}
  .hit{display:inline-block;font-size:12px;color:#1d4ed8;background:#e0ecff;border:1px solid #bfdbfe;border-radius:999px;padding:2px 8px;margin-left:6px}
  .src{font-size:15px;margin-top:10px}
  .src a{
    display:inline-block;padding:10px 12px;border:1px solid var(--b);border-radius:10px;
    color:var(--link);text-decoration:none;-webkit-tap-highlight-color:transparent;
  }
  .src .rawurl{display:block;margin-top:6px;word-break:break-all}
  mark{background:var(--hl);padding:0 .15em;border-radius:3px}

  .badge{display:inline-block;background:#fff7ed;border:1px solid #fed7aa;border-radius:999px;padding:4px 10px;font-size:12px;color:#92400e}
  .notice{margin-top:16px;background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:10px}
  .howto{margin-top:16px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:10px}
  .date{font-size:14px;color:#374151;margin-top:2px}
</style>
</head>
<body>
  <div class="container">
    <h1>ãƒŸãƒ‹ãƒãƒ©ç›†æ ½æ„›å¥½ä¼š ãƒ‡ã‚¸ã‚¿ãƒ«è³‡æ–™é¤¨</h1>

    <div class="toolbar">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700;color:#ef4444">æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </div>
        <span class="badge">å¹´ã§ã—ã¼ã‚‹ï¼‹ãƒšãƒ¼ã‚¸é€ã‚Š</span>
      </div>

      <div class="row" style="margin-top:8px">
        <input id="q" type="text" placeholder="ä¾‹ï¼‰ ã‚³ãƒ³ãƒ†ã‚¹ãƒˆçµæœã€€ï¼ã€€ä¾‹ï¼‰ ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ 2023ã€€ï¼ã€€ä¾‹ï¼‰ å§«ä¹™å¥³ å—è³" />
        <select id="order" title="ä¸¦ã³é †" disabled>
          <option value="relevance">é–¢é€£é †</option>
          <option value="latest" selected>æœ€æ–°é †</option>
        </select>
        <button class="primary" id="btnSearch">æ¤œç´¢</button>
        <button id="btnClear">ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="api" style="margin-top:6px">
        API: <code>/api/search</code> ï½œ ç‰ˆ: <span id="ver">â€¦</span> ï½œ
        <a id="lnkHealth" href="/health">/health</a> ãƒ»
        <a id="lnkVersion" href="/version">/version</a><br/>
        â€» ã“ã®ç”»é¢ã®æ¤œç´¢ã¯ <strong>å¸¸ã«ã€Œæœ€æ–°é †ï¼ˆorder=latestï¼‰ã€ã§è¡¨ç¤º</strong> ã—ã¾ã™ã€‚
      </div>
    </div>

    <div class="section">
      <h2>æ¤œç´¢çµæœï¼ˆæ•´å½¢è¡¨ç¤ºï¼‰</h2>
      <div class="body">
        <div id="meta" class="meta">ï¼ˆæœªå–å¾—ï¼‰</div>
        <div id="results"></div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="prev" disabled>å‰ã¸</button>
          <button id="next" disabled>æ¬¡ã¸</button>
        </div>
      </div>
    </div>

    <div class="notice">
      <strong>ãŠçŸ¥ã‚‰ã›</strong><br/>
      ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¯ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŸã‚ä¸€æ™‚åœæ­¢ä¸­ã§ã™ã€‚æ¤œç´¢ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
    </div>

    <div class="howto">
      <h3>ä½¿ã„ã‹ãŸ</h3>
      <ol style="margin:6px 0 0;padding-left:1.2em">
        <li>ã“ã¨ã°ã‚’å…¥ã‚Œã¦ã€Œæ¤œç´¢ã€ã‚’æŠ¼ã™ã€‚</li>
        <li>1ãƒšãƒ¼ã‚¸ã¯<strong>å¸¸ã«5ä»¶</strong>ã€‚å…ˆé ­ã ã‘<strong>æœ¬æ–‡ã‚’ç´„300å­—</strong>è¡¨ç¤ºã€2ã€œ5ä»¶ã¯<strong>ãƒã‚¤ãƒ©ã‚¤ãƒˆå‘¨è¾º</strong>ã®ã¿ã€‚</li>
        <li>ç¶šãã¯æ¬¡ã¸ã€æˆ»ã‚‹ã¨ãã¯å‰ã¸ï¼ˆãƒšãƒ¼ã‚¸é€ã‚Šï¼‰ã€‚</li>
        <li>å¹´ã§ã—ã¼ã‚‹ã¨ãã¯èªå°¾ã«è¥¿æš¦4æ¡ã€‚<span style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px">ä¾‹ï¼šã‚³ãƒ³ãƒ†ã‚¹ãƒˆ 2023</span></li>
        <li>å¹´ã®ç¯„å›²ã¯ãƒã‚¤ãƒ•ãƒ³ã€‚<span style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px">ä¾‹ï¼šå‰ªå®š 1999-2001</span></li>
      </ol>
    </div>
  </div>

<!-- === Main Script (æ—¢å­˜ã®æ¤œç´¢UIãƒ­ã‚¸ãƒƒã‚¯) === -->
<script>
  const PAGE_SIZE = 5;
  const $ = (id) => document.getElementById(id);
  const asArray = (x) => Array.isArray(x) ? x : [];

  async function jget(url){
    const r = await fetch(url, {cache:"no-store", headers:{Accept:"application/json"}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }

  function hasMark(html){ return /<mark>/.test(html||""); }

  function setPagerDisabled(disabled){
    $("prev").disabled = disabled;
    $("next").disabled = disabled;
  }

  function whereHit(matches){
    if(!matches) return "";
    const labels = [];
    if(matches.title && matches.title.length) labels.push("ã‚¿ã‚¤ãƒˆãƒ«ã«ãƒ’ãƒƒãƒˆ");
    if(matches.tags  && matches.tags.length)  labels.push("ã‚¿ã‚°ã«ãƒ’ãƒƒãƒˆ");
    if(matches.body  && matches.body.length)  labels.push("æœ¬æ–‡ã«ãƒ’ãƒƒãƒˆ");
    return labels.length ? `ï¼ˆ${labels.join("ãƒ»")}ï¼‰` : "";
  }

  async function doSearch(page){
    const q=$("q").value.trim(); if(!q){
      $("results").innerHTML=""; $("meta").textContent="ï¼ˆæœªå–å¾—ï¼‰";
      setPagerDisabled(true);
      return;
    }
    $("btnSearch").disabled=true; $("meta").textContent="æ¤œç´¢ä¸­â€¦"; $("results").innerHTML="";
    try{
      const ord="latest"; // UIå´ã¯å¸¸ã«æœ€æ–°é †
      const url=`/api/search?q=${encodeURIComponent(q)}&page=${page}&page_size=${PAGE_SIZE}&order=${encodeURIComponent(ord)}&debug=1`;
      const raw=await jget(url);
      const items=asArray(raw?.items)||[];
      if(!items.length){
        $("meta").textContent="è©²å½“ãªã—";
        $("results").innerHTML="";
        setPagerDisabled(true);
        return;
      }

      $("results").innerHTML=items.map((it,i)=>{
        const title = it.title || "(ç„¡é¡Œ)";
        const content = it.content || "";
        const url = it.url || "";
        const hitLabel = whereHit(it.matches) || (hasMark(content) ? "ï¼ˆæœ¬æ–‡ã«ãƒ’ãƒƒãƒˆï¼‰" : "");
        const link = url ? `<div class="src"><a href="${url}" target="_blank" rel="noopener noreferrer">æœ¬æ–‡è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¸‹ã•ã„ã€‚ï¼‰</a></div>` : "";
        const date = it.date ? `<div class="date">ç™ºè¡Œæ—¥ï¼š${it.date}</div>` : "";
        return `<div class="result"><div class="title">${title}<span class="hit">${hitLabel || "\u00A0"}</span></div><div class="snippet">${content}</div>${date}${link}</div>`;
      }).join("");

      const total = raw.total_hits ?? items.length;
      const from = (page-1)*PAGE_SIZE + 1;
      const to   = Math.min(page*PAGE_SIZE, total);
      $("meta").textContent=`${total} ä»¶ä¸­ ${from}â€“${to} ä»¶ã‚’è¡¨ç¤ºï¼ˆ${raw.order_used||ord}ï¼‰`;
      $("prev").disabled = page<=1;
      $("next").disabled = !raw.has_more;
      window.__page=page;
    }catch(e){
      $("meta").textContent=`ã‚¨ãƒ©ãƒ¼ï¼š${String(e.message||e)}`;
      setPagerDisabled(true);
    }finally{ $("btnSearch").disabled=false; }
  }

  // --- ã‚¤ãƒ™ãƒ³ãƒˆ
  $("btnSearch").addEventListener("click", ()=>doSearch(1));
  $("btnClear").addEventListener("click", ()=>{ $("q").value=""; $("results").innerHTML=""; $("meta").textContent="ï¼ˆæœªå–å¾—ï¼‰"; setPagerDisabled(true); });
  $("prev").addEventListener("click", ()=>{ const p=Math.max(1,(window.__page||1)-1); doSearch(p); });
  $("next").addEventListener("click", ()=>{ const p=(window.__page||1)+1; doSearch(p); });
  $("q").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ doSearch(1); } });

  (async ()=>{ try{ const r=await jget("/version"); $("ver").textContent=r.version||"â€”"; }catch{} })();

  // --- PWA: Service Worker ç™»éŒ²ï¼ˆSafariå¯¾å¿œï¼‰
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      const sw = `/service-worker.js?v=${encodeURIComponent(window.VER||"")}`;
      navigator.serviceWorker.register(sw, { scope: "/" }).catch(()=>{});
    });
  }

  // --- æ—¢å®šï¼š/health /version ã®ãƒªãƒ³ã‚¯ã¯ä¸€æ—¦ãã®ã¾ã¾ï¼ˆå¾Œæ®µã®è£œå¼·ã§å¤–éƒ¨ã‚¿ãƒ–åŒ–ï¼‰
  const lH = $("lnkHealth"), lV = $("lnkVersion");
  if (lH && lV) {
    const verQ = (u)=> `${u}${u.includes("?")?"&":"?"}v=${encodeURIComponent(window.VER||"")}`;
    lH.href = verQ("/health");
    lV.href = verQ("/version");
  }
</script>
<!-- === /Main Script === -->

<!-- === A+B Enhancerï¼ˆå³ä¸‹ã€ŒğŸ  ãƒ›ãƒ¼ãƒ ã€ï¼‹ /health,/version ã‚’å¤–éƒ¨ã‚¿ãƒ–ï¼‰=== -->
<script>
(function () {
  const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)
                    || (window.navigator.standalone === true);

  // B: /health /version ã‚’å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆæ–°è¦ã‚¿ãƒ–ï¼‰ã§é–‹ã
  function patchExternalOpen() {
    const selector = 'a[href="/health"], a[href="/version"], a[href^="/health?"], a[href^="/version?"]';
    document.querySelectorAll(selector).forEach(a => {
      a.setAttribute('target', '_blank');
      a.setAttribute('rel', 'noopener');
      if (isStandalone) {
        a.addEventListener('click', function (e) {
          e.preventDefault();
          try { window.open(a.href, '_blank', 'noopener'); } catch (_) {}
        }, { capture:true });
      }
    });
  }

  // A: å³ä¸‹ã«ã€ŒğŸ  ãƒ›ãƒ¼ãƒ ã€ãƒœã‚¿ãƒ³ï¼ˆ/uiã¸ï¼‰
  function injectHomeButton() {
    if (document.getElementById('mr-home-fab')) return;
    const btn = document.createElement('button');
    btn.id='mr-home-fab'; btn.type='button'; btn.textContent='ğŸ  ãƒ›ãƒ¼ãƒ ';
    btn.title='ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ï¼ˆ/uiï¼‰';
    Object.assign(btn.style,{
      position:'fixed', right:'16px', bottom:'16px', zIndex:'2147483647',
      padding:'10px 14px', border:'1px solid rgba(0,0,0,.1)', borderRadius:'999px',
      background:'#fff', boxShadow:'0 4px 12px rgba(0,0,0,.12)',
      color:'#111827', fontSize:'14px', lineHeight:'1', cursor:'pointer',
      WebkitTapHighlightColor:'transparent'
    });
    btn.addEventListener('click', ()=>{ try{ location.assign('/ui'); }catch(_){ location.href='/ui'; } });
    document.body.appendChild(btn);
  }

  function onReady(fn){ document.readyState!=='loading' ? fn() : document.addEventListener('DOMContentLoaded', fn); }
  onReady(() => {
    patchExternalOpen();
    injectHomeButton();
    // SPAçš„ãªé…å»¶ç”Ÿæˆã«å‚™ãˆè»½ãå†é©ç”¨ï¼ˆæœ€å¤§60å›ï¼ç´„1åˆ†ï¼‰
    let n=0; const iv=setInterval(()=>{ patchExternalOpen(); if(++n>60) clearInterval(iv); },1000);
  });
})();
</script>
<!-- === /A+B Enhancer === -->

</body>
</html>
