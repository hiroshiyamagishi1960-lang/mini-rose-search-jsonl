<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ミニバラ盆栽愛好会 デジタル資料館｜検索（JSONL版）</title>
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#AEE6B8">
<meta name="robots" content="noindex" />
<link rel="apple-touch-icon" href="/static/icon-192.png">
<style>
  :root{
    --bg:#fafafa; --card:#fff; --b:#e5e7eb; --muted:#64748b; --txt:#0f172a;
    --link:#2563eb; --hl:#e6f3ff; --ink:#1e3a8a; --inbg:#eaf2ff;
    --accent:#AEE6B8;
  }
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.7}
  html{font-size:18px}
  @media (max-width:480px){ html{font-size:19px} }

  /* 共通ボタン */
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:.5em;
    padding:12px 16px; min-height:44px; font-size:16px;
    border:1px solid var(--b); border-radius:12px; background:#fff; color:#111;
    text-decoration:none; cursor:pointer; -webkit-tap-highlight-color:transparent; user-select:none;
  }
  .btn.primary{ background:#e7f0ff; border-color:#bfdbfe; }
  .btn.ghost{ background:#fff; }
  .btn.block{ width:100%; font-weight:700; }
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  .container{max-width:1000px;margin:18px auto;padding:0 16px}
  h1{margin:0 0 12px;font-size:22px;font-weight:800}

  .toolbar{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .api{font-size:12px;color:var(--muted)}

  input[type="text"]{
    flex:1 1 520px;min-width:260px;
    padding:16px 18px;border-radius:12px;background:var(--inbg);
    border:3px solid var(--ink); outline:none; font-size:18px;
  }
  select,button{border:1px solid var(--b);border-radius:10px;background:#fff;font-size:16px;line-height:1.2}
  select{padding:12px 12px}
  button{padding:12px 16px;cursor:pointer;min-height:44px;background:#f8fafc}
  button.primary{background:#e7f0ff;border-color:#bfdbfe}
  .section{background:var(--card);border:1px solid var(--b);border-radius:16px;margin-top:16px}
  .section h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--b);font-size:16px}
  .section .body{padding:12px 16px}

  .meta{font-size:14px;margin-bottom:8px;color:var(--muted)}
  .result{border:1px solid var(--b);border-radius:14px;padding:12px;background:#fff;margin-bottom:12px}
  .title{font-weight:800;font-size:20px;margin-bottom:6px}
  .snippet{white-space:pre-wrap;word-break:break-word}
  .hit{display:inline-block;font-size:12px;color:#1d4ed8;background:#e0ecff;border:1px solid #bfdbfe;border-radius:999px;padding:2px 8px;margin-left:6px}
  .src{font-size:15px;margin-top:10px}
  .src a{display:inline-flex;align-items:center;gap:.4em}

  mark{background:var(--hl);padding:0 .15em;border-radius:3px}

  .notice{margin-top:16px;background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:10px}
  .howto{margin-top:16px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:10px}

  /* ====== 同一画面・本文ビュー（全画面切替） ====== */
  .detail-wrap{
    position:fixed; inset:0; display:none; z-index:1000; background:#fff;
  }
  .detail{
    position:absolute; inset:0; display:flex; flex-direction:column; background:#fff;
  }
  .detail-head{
    position:sticky; top:0; display:flex; align-items:center; gap:8px;
    padding:8px 10px; background:#ffffffee; backdrop-filter:blur(6px); border-bottom:1px solid var(--b); z-index:2;
  }
  .detail-head .ttl{font-weight:700; font-size:16px; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .detail-body{flex:1; background:#fff}
  .detail-body iframe{width:100%; height:100%; border:0}
  .detail-foot{
    position:sticky; bottom:0; padding:12px; border-top:1px solid var(--b); background:#ffffffee; backdrop-filter:blur(6px); z-index:2;
  }

  /* アクセシビリティ：フォーカス見やすく */
  :focus-visible{ outline:3px solid #60a5fa; outline-offset:2px; border-radius:6px; }
</style>
</head>
<body>
  <div class="container" id="searchView" aria-label="検索画面">
    <h1>ミニバラ盆栽愛好会 デジタル資料館</h1>

    <div class="howto" aria-live="polite">
      <strong>使いかた</strong><br/>
      ① ことばを入れて「検索」 → ② 気になる結果で「↗ 開く」 → ③ 見終わったら <strong>← 戻る</strong>（端末の戻る or 画面の戻るボタン）
    </div>

    <div class="toolbar" role="search">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700;color:#ef4444">検索システム</div>
        <span style="display:inline-block;background:#fff7ed;border:1px solid #fed7aa;border-radius:999px;padding:4px 10px;font-size:12px;color:#92400e">年でしぼる＋ページ送り</span>
      </div>

      <div class="row" style="margin-top:8px">
        <input id="q" type="text" placeholder="例） コンテスト結果 ／ 例） コンテスト 2023 ／ 例） 剪定 1999-2001" aria-label="検索語を入力" />
        <select id="order" title="並び順" disabled aria-disabled="true">
          <option value="relevance">関連順</option>
          <option value="latest" selected>最新順</option>
        </select>
        <button class="btn primary" id="btnSearch" type="button">検索</button>
        <button class="btn" id="btnClear" type="button">クリア</button>
      </div>

      <div class="api" style="margin-top:6px">
        API: <code>/api/search</code> ｜ 版: <span id="ver">…</span> ｜
        <a href="/health" target="_blank" rel="noopener">/health</a> ・
        <a href="/version" target="_blank" rel="noopener">/version</a><br/>
        ※ この画面の検索は <strong>常に「最新順（order=latest）」で表示</strong> します。
      </div>
    </div>

    <div class="section" aria-live="polite">
      <h2>検索結果（整形表示）</h2>
      <div class="body">
        <div id="meta" class="meta">（未取得）</div>
        <div id="results"></div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button class="btn" id="prev" type="button" disabled>前へ</button>
          <button class="btn" id="next" type="button" disabled>次へ</button>
        </div>
      </div>
    </div>

    <div class="notice" role="note">
      <strong>お知らせ</strong><br/>
      チャット機能はメンテナンスのため一時停止中です。検索をご利用ください。
    </div>
  </div>

  <!-- 同一画面・本文ビュー（全画面表示／新規タブなし） -->
  <div class="detail-wrap" id="detailWrap" aria-hidden="true">
    <div class="detail" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <div class="detail-head">
        <button id="detailBackTop" class="btn" type="button" aria-label="検索に戻る">← 検索に戻る</button>
        <div id="detailTitle" class="ttl">本文表示</div>
        <a id="detailOpenExternal" class="btn ghost" href="#" target="_blank" rel="noopener" aria-label="外部ブラウザで開く">↗ 外部で開く</a>
      </div>
      <div class="detail-body">
        <iframe id="detailFrame" src="about:blank" title="本文"></iframe>
      </div>
      <div class="detail-foot">
        <button id="detailBackBottom" class="btn block" type="button" aria-label="検索に戻る（下部）」>← 検索に戻る</button>
      </div>
    </div>
  </div>

<script>
  (function(){
    const PAGE_SIZE = 5;
    const $ = (id) => document.getElementById(id);
    const asArray = (x) => Array.isArray(x) ? x : [];
    function hasMark(html){ return /<mark>/.test(html||""); }
    function setPagerDisabled(disabled){
      $("prev").disabled = !!disabled;
      $("next").disabled = !!disabled;
    }
    async function jget(url){
      const r = await fetch(url, {cache:"no-store", headers:{Accept:"application/json"}});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    // ===== 検索 =====
    async function doSearch(page){
      const q=$("q").value.trim();
      if(!q){
        $("results").innerHTML=""; $("meta").textContent="（未取得）";
        setPagerDisabled(true); return;
      }
      $("btnSearch").disabled=true; $("meta").textContent="検索中…"; $("results").innerHTML="";
      try{
        const ord="latest";
        const url=`/api/search?q=${encodeURIComponent(q)}&page=${page}&page_size=${PAGE_SIZE}&order=${encodeURIComponent(ord)}`;
        const raw=await jget(url);
        const items=asArray(raw && raw.items)||[];
        if(!items.length){
          $("meta").textContent="該当なし。語を減らす／年を外す／別表記をお試しください。";
          $("results").innerHTML=""; setPagerDisabled(true); return;
        }
        $("results").innerHTML=items.map((it,i)=>{
          const title = it && it.title ? it.title : "(無題)";
          const content = it && it.content ? it.content : "";
          const url = it && it.url ? it.url : "";
          const hit = hasMark(content) ? '<span class="hit">（本文にヒット）</span>' : '';
          const link = url
            ? `<div class="src">
                 <a href="#" class="open-in-page" data-url="${encodeURIComponent(url)}" aria-label="本文を同じ画面で開く">↗ 開く</a>
               </div>` : "";
          return `<div class="result">
                    <div class="title">${title}${hit}</div>
                    <div class="snippet">${content}</div>
                    ${link}
                  </div>`;
        }).join("");
        const total = (raw && typeof raw.total_hits==="number") ? raw.total_hits : items.length;
        const from = (page-1)*PAGE_SIZE + 1;
        const to   = Math.min(page*PAGE_SIZE, total);
        $("meta").textContent=`${total} 件中 ${from}–${to} 件を表示（${raw && raw.order_used ? raw.order_used : ord}）`;
        $("prev").disabled = page<=1;
        $("next").disabled = !(raw && raw.has_more);
        window.__page=page;

        // クリック委任：同一画面で本文表示
        document.querySelectorAll(".open-in-page").forEach(a=>{
          a.addEventListener("click",(e)=>{
            e.preventDefault();
            const url = decodeURIComponent(a.getAttribute("data-url")||"");
            if(url){ openDetail(url, a.closest(".result")?.querySelector(".title")?.textContent || "本文表示"); }
          });
        });
      }catch(e){
        $("meta").textContent=`エラー：${String(e && e.message ? e.message : e)}`;
        setPagerDisabled(true);
      }finally{ $("btnSearch").disabled=false; }
    }

    $("btnSearch").addEventListener("click", ()=>doSearch(1));
    $("btnClear").addEventListener("click", ()=>{
      $("q").value=""; $("results").innerHTML=""; $("meta").textContent="（未取得）"; setPagerDisabled(true);
    });
    $("prev").addEventListener("click", ()=>{ const p=Math.max(1,(window.__page||1)-1); doSearch(p); });
    $("next").addEventListener("click", ()=>{ const p=(window.__page||1)+1; doSearch(p); });
    $("q").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ doSearch(1); } });

    (async ()=>{ try{ const r=await jget("/version"); if(r && r.version){ $("ver").textContent=r.version; } }catch{} })();

    // ===== 同一画面・本文ビュー（全画面／戻る上・下） =====
    function openDetail(url, titleText){
      // タイトルとリンク設定
      $("detailTitle").textContent = titleText || "本文表示";
      $("detailOpenExternal").href = url;

      // 表示切替
      $("detailFrame").src = url;
      $("detailWrap").style.display = "block";
      $("detailWrap").setAttribute("aria-hidden","false");

      // 履歴を積む（端末の戻る1回で検索ビューへ戻す）
      try{ history.pushState({view:"detail"}, "", "#detail"); }catch{}
      // フォーカス移動（読み上げ・キーボード向け）
      $("detailBackTop").focus();
    }
    function closeDetail(){
      $("detailFrame").src = "about:blank";
      $("detailWrap").style.display = "none";
      $("detailWrap").setAttribute("aria-hidden","true");
      // 検索欄へフォーカス戻し
      try{ $("q").focus(); }catch{}
      // ハッシュを消す（戻る履歴も1つ戻す）
      if(location.hash === "#detail"){
        try{ history.back(); }catch{}
      }
    }

    $("detailBackTop").addEventListener("click", closeDetail);
    $("detailBackBottom").addEventListener("click", closeDetail);

    // 物理/ジェスチャー戻るで閉じる
    window.addEventListener("popstate", ()=>{
      if(location.hash !== "#detail"){ // detailビューが閉じられた状態
        $("detailFrame").src = "about:blank";
        $("detailWrap").style.display = "none";
        $("detailWrap").setAttribute("aria-hidden","true");
      }
    });
  })();
</script>
</body>
</html>
