<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ミニバラ盆栽愛好会 デジタル資料館｜検索（JSONL版）</title>
<meta name="robots" content="noindex" />
<style>
  :root{
    --bg:#fafafa; --card:#fff; --b:#e5e7eb; --muted:#64748b; --txt:#0f172a;
    --link:#2563eb; --hl:#e6f3ff; --ink:#1e3a8a; --inbg:#eaf2ff;
    --warn:#fff7cc; --warn-b:#fde68a; --how:#ffeff0; --how-b:#fecdd3;
  }
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.7}
  html{font-size:18px}
  @media (max-width:480px){ html{font-size:19px} }

  .container{max-width:1000px;margin:18px auto;padding:0 16px}
  h1{margin:0 0 12px;font-size:26px}

  .toolbar{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .api{font-size:12px;color:var(--muted)}

  /* 入力欄：濃紺の太枠＋薄い青の背景 */
  input[type="text"]{
    flex:1 1 460px;min-width:260px;
    padding:14px 16px;border-radius:12px;background:var(--inbg);
    border:3px solid var(--ink); outline:none; font-size:18px;
  }
  select,button{border:1px solid var(--b);border-radius:10px;background:#fff;font-size:16px;line-height:1.2}
  select{padding:10px 12px}
  button{padding:10px 16px;cursor:pointer;min-height:44px;background:#f8fafc}
  button.primary{background:#e7f0ff;border-color:#bfdbfe}
  button[disabled]{opacity:.5;cursor:not-allowed}

  .section{background:var(--card);border:1px solid var(--b);border-radius:16px;margin-top:16px}
  .section h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--b);font-size:16px}
  .section .body{padding:12px 16px}

  .meta{font-size:14px;margin-bottom:8px;color:var(--muted)}
  .result{border:1px solid var(--b);border-radius:14px;padding:12px;background:#fff;margin-bottom:12px}
  .title{font-weight:700;font-size:20px;margin-bottom:4px}
  .snippet{white-space:pre-wrap;word-break:break-word}
  .hit{display:inline-block;font-size:12px;color:#1d4ed8;background:#e0ecff;border:1px solid #bfdbfe;border-radius:999px;padding:2px 8px;margin-left:6px}
  .src{font-size:15px;margin-top:8px}
  .src a{
    display:inline-block;padding:10px 12px;border:1px solid var(--b);border-radius:10px;
    color:var(--link);text-decoration:none;-webkit-tap-highlight-color:transparent;
  }
  .src a:focus-visible{ outline:2px solid #93c5fd; outline-offset:2px }

  details summary{cursor:pointer;padding:12px 16px;border-bottom:1px solid var(--b)}
  .json{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;background:#0b1020;color:#d1e7ff;border-radius:12px;padding:10px;overflow:auto}

  .notice{background:var(--warn);border:1px solid var(--warn-b);border-radius:14px;padding:12px 14px;margin-top:16px}
  .howto{background:var(--how);border:1px solid var(--how-b);border-radius:14px;padding:14px;margin-top:12px}
  .howto h3{margin:0 0 8px}

  mark{background:var(--hl);padding:0 .15em;border-radius:3px}
</style>
</head>
<body>
  <div class="container">
    <h1>ミニバラ盆栽愛好会 デジタル資料館</h1>

    <div class="toolbar">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700;color:#ef4444">検索システム</div>
        <span style="display:inline-block;background:#fff7ed;border:1px solid #fed7aa;border-radius:999px;padding:4px 10px;font-size:12px;color:#92400e">年でしぼる＋ページ送り</span>
      </div>

      <div class="row" style="margin-top:8px">
        <input id="q" type="text" placeholder="例） コンテスト結果　／　例） コンテスト 2023　／　例） 剪定 1999-2001" />
        <select id="order" title="並び順">
          <option value="relevance" selected>関連順</option>
          <option value="latest">最新順</option>
        </select>
        <button class="primary" id="btnSearch">検索</button>
        <button id="btnClear">クリア</button>
      </div>

      <div class="api" style="margin-top:6px">
        API: <code>/api/search</code> ｜ 版: <span id="ver">…</span> ｜
        <a href="/health" target="_blank" rel="noopener">/health</a> ・
        <a href="/version" target="_blank" rel="noopener">/version</a>
      </div>
    </div>

    <div class="section">
      <h2>検索結果（整形表示）</h2>
      <div class="body">
        <div id="meta" class="meta">（未取得）</div>
        <div id="results"></div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="prev" disabled>前へ</button>
          <button id="next" disabled>次へ</button>
        </div>
      </div>
    </div>

    <details class="section" style="margin-top:12px">
      <summary>開発者向け：レスポンス（生のJSON）</summary>
      <div class="body">
        <div class="meta">※ タイトルと本文の<strong>ハイライト（薄い青）</strong>はサーバの <code>&lt;mark&gt;</code> をそのまま表示します。<span class="hit">（本文にヒット）</span> は本文に <code>&lt;mark&gt;</code> がある時に付与します。</div>
        <div id="raw" class="json">（未取得）</div>
      </div>
    </details>

    <!-- お知らせ（復活） -->
    <div class="notice">
      <strong>お知らせ</strong><br/>
      チャット機能はメンテナンスのため一時停止中です。検索をご利用ください。
    </div>

    <!-- 使いかた（復活） -->
    <div class="howto">
      <h3>使いかた</h3>
      <ol style="margin:6px 0 0;padding-left:1.2em">
        <li>ことばを入れて「検索」を押す。</li>
        <li>1ページは<strong>常に5件</strong>。先頭だけ<strong>本文を約300字</strong>表示、2〜5件は<strong>ハイライト周辺</strong>のみ。</li>
        <li>続きは次へ、戻るときは前へ（ページ送り）。</li>
        <li>年でしぼるときは語尾に西暦4桁。<span style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px">例：コンテスト 2023</span></li>
        <li>年の範囲はハイフン。<span style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px">例：剪定 1999-2001</span></li>
      </ol>
    </div>
  </div>

<script>
  /* ===== 挙動 ===== */
  const PAGE_SIZE = 5; // 常に5件固定
  const $ = (id) => document.getElementById(id);
  const asArray = (x) => Array.isArray(x) ? x : [];
  const sanitize = (s) => (typeof s === "string") ? s : "";
  const stripExceptMark = (h) => sanitize(h).replace(/<(?!\/?mark\b)[^>]+>/g, "");
  const hasMark = (h) => /<mark>/.test(h||"");

  // 先頭：<mark>活かして約300字（±40）
  function approx300(html, target=300){
    const s = stripExceptMark(html);
    const plain = s.replace(/<\/?mark>/g,"");
    if (plain.length <= target+40) return s;
    const m = s.indexOf("<mark>");
    if (m === -1) return plain.slice(0,target) + "…";
    const end = s.indexOf("</mark>", m);
    const half = Math.floor(target/2);
    const start = Math.max(0, m - half);
    const finish = Math.min(s.length, (end>-1?end+7:m+6) + half);
    return (start>0?"…":"") + s.slice(start, finish) + (finish<s.length?"…":"");
  }
  // 残り：<mark>前後だけ（無ければ先頭160）
  function aroundMark(html, side=80, fallback=160){
    const s = stripExceptMark(html);
    const m = s.indexOf("<mark>");
    if (m === -1){
      const t = s.replace(/<\/?mark>/g,"");
      return t.length > fallback ? t.slice(0,fallback) + "…" : t;
    }
    const end = s.indexOf("</mark>", m);
    const start = Math.max(0, m - side);
    const finish = Math.min(s.length, (end>-1?end+7:m+6) + side);
    return (start>0?"…":"") + s.slice(start,finish) + (finish<s.length?"…":"");
  }

  async function jget(url){
    const r = await fetch(url, {cache:"no-store", headers:{Accept:"application/json"}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }
  function normalize(raw, page){
    const items = asArray(raw?.items)||asArray(raw?.results)||[];
    const norm = items.map(it=>{
      const title = stripExceptMark(it.title||"(無題)");
      const content = sanitize(it.content||it.text||"");
      const url = sanitize(it.url||it.source||"");
      const date = sanitize(it.date||it.date_primary||"");
      const rank = (typeof it.rank==="number") ? it.rank : null;
      return {title,content,url,date,rank};
    });
    return {
      items:norm,
      total:(typeof raw?.total_hits==="number")?raw.total_hits:norm.length,
      has_more:!!raw?.has_more,
      order_used: raw?.order_used || null,
      page
    };
  }
  function metaText(total,page,shown,order_used){
    const start=(page-1)*PAGE_SIZE+1, end=Math.min(total,start+shown-1);
    return `${total} 件中 ${start}–${end} 件を表示　/　order_used: ${order_used||"unknown"}`;
  }
  function rowFirst(it){
    return `
      <div class="result">
        <div class="title">${it.title}${hasMark(it.content)?'<span class="hit">（本文にヒット）</span>':''}</div>
        <div class="snippet">${approx300(it.content,300)}</div>
        ${it.url?`<div class="src"><a href="${it.url}" target="_blank" rel="noopener">本文表示（クリックして下さい。）</a></div>`:""}
      </div>`;
  }
  function rowRest(it){
    return `
      <div class="result">
        <div class="title">${it.title}</div>
        <div class="snippet">${aroundMark(it.content,80,160)}</div>
        ${it.url?`<div class="src"><a href="${it.url}" target="_blank" rel="noopener">本文表示（クリックして下さい。）</a></div>`:""}
      </div>`;
  }

  async function doSearch(page){
    const q=$("q").value.trim(); if(!q){
      $("results").innerHTML=""; $("meta").textContent="（未取得）"; $("raw").textContent="（未取得）";
      $("prev").disabled=true; $("next").disabled=true; return;
    }
    $("btnSearch").disabled=true; $("prev").disabled=true; $("next").disabled=true;
    $("meta").textContent="検索中…"; $("results").innerHTML="";
    try{
      const ord=$("order").value;
      const url=`/api/search?q=${encodeURIComponent(q)}&page=${page}&page_size=${PAGE_SIZE}&order=${encodeURIComponent(ord)}`;
      const raw=await jget(url); $("raw").textContent=JSON.stringify(raw,null,2);
      const data=normalize(raw,page);
      if(data.order_used && $("order").value!==data.order_used){ $("order").value=data.order_used; }
      const items=data.items;
      if(!items.length){ $("meta").textContent="該当なし"; return; }
      $("results").innerHTML = rowFirst(items[0]) + items.slice(1).map(rowRest).join("");
      $("meta").textContent = metaText(data.total,data.page,items.length,data.order_used);
      $("prev").disabled = page<=1; $("next").disabled=!data.has_more; window.__page=page;
    }catch(e){
