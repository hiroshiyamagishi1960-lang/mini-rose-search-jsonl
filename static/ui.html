<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ミニバラ盆栽愛好会 デジタル資料館</title>

  <!-- PWA: manifest / theme-color / iOS用タイトルとアイコン -->
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ミニバラ盆栽資料館" />

  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", "Segoe UI", system-ui, sans-serif;
      background: #f9fafb;
      color: #111;
      margin: 0;
      padding: 1.5rem;
    }
    h1 { font-size: 1.6rem; margin-bottom: .5rem; }
    #q {
      width: 100%;
      padding: .6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: .5rem;
      margin-bottom: 1rem;
    }
    button {
      padding: .5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: .5rem;
      background: #4b5563;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #374151; }
    .result {
      background: white;
      border-radius: .5rem;
      padding: 1rem;
      margin-top: .8rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    mark {
      background: #fff59d;
      padding: 0 2px;
      border-radius: 2px;
    }
    .api {
      font-size: 0.9rem;
      color: #475569;
    }
    .footer {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 2rem;
      text-align: right;
    }
  </style>
</head>

<body>
  <h1>ミニバラ盆栽愛好会 デジタル資料館</h1>

  <input id="q" type="text" placeholder="検索語を入力（例：剪定 苔 展示会...）" />
  <div>
    <button onclick="doSearch(1)">検索</button>
  </div>

  <div id="out"></div>

  <div class="api" style="margin-top:6px">
    API: <code>/api/search</code> ｜ 版: <span id="ver">…</span> ｜
    <a href="/health" target="_blank" rel="noopener">/health</a> ・
    <a href="/version" target="_blank" rel="noopener">/version</a>
    ・ <span id="readyState" style="color:#64748b">準備状態: 取得中…</span>
  </div>

  <div class="footer">
    &copy; ミニバラ盆栽愛好会 / Hiroshi Yamagishi
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const api = "/api/search";

    async function jget(url){
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error(r.status);
      return await r.json();
    }

    async function doSearch(page){
      const q = $("q").value.trim();
      if(!q){ $("out").innerHTML="<p>検索語を入力してください。</p>"; return; }
      $("out").innerHTML="<p>検索中...</p>";
      try{
        const url = `${api}?q=${encodeURIComponent(q)}&page=${page}&page_size=5&order=latest`;
        const j = await jget(url);
        render(j);
      }catch(e){
        $("out").innerHTML="<p>エラー: "+e+"</p>";
      }
    }

    function render(j){
      if(!j || !j.items){ $("out").innerHTML="<p>該当なし。</p>"; return; }
      const out=[];
      out.push(`<p>ヒット件数: ${j.total_hits} 件　（ページ ${j.page}）</p>`);
      for(const it of j.items){
        out.push(`<div class="result">
          <div><strong>${it.title}</strong></div>
          <div>${it.content||""}</div>
          <div style="margin-top:4px;font-size:0.9rem;">
            <a href="${it.url||'#'}" target="_blank" rel="noopener">本文表示（クリックしてください）</a>
            ${it.date_primary ? "　📅 "+it.date_primary : "" }
          </div>
        </div>`);
      }
      $("out").innerHTML = out.join("");
    }

    async function showReady(){
      try{
        const r = await fetch("/ready", {cache:"no-store"});
        if(!r.ok) throw new Error("ready ng");
        const j = await r.json();
        const s = j?.ok ? "OK" : (j?.detail || "準備中");
        const el = $("readyState");
        if(el){ el.textContent = `準備状態: ${s}`; }
      }catch{
        const el = $("readyState");
        if(el){ el.textContent = "準備状態: 不明"; }
      }
    }

    (async ()=>{
      try{
        const v = await jget("/version");
        $("ver").textContent = v.version || "—";
      }catch{}
      await showReady();
      const usp=new URLSearchParams(location.search);
      if(usp.get("q")){ $("q").value=usp.get("q"); doSearch(1); }
    })();
  </script>
</body>
</html>
